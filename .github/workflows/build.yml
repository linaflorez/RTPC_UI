name: Build MacOS App and Publish Release

permissions:
  contents: write

on:
  push:
    tags:
      - 'v*'  # Trigger workflow on version tags like v1.0, v1.1, etc.

jobs:
  build:
    runs-on: macos-latest

    strategy:
      matrix:
        python-version: ['3.9']  # Add the versions of Python you want to test

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install py2app

      - name: Extract tag name
        id: extract_tag
        run: echo "TAG_NAME=${GITHUB_REF##*/}" >> $GITHUB_ENV

      - name: Build with py2app
        run: |
          python setup.py py2app

      - name: Compress app into zip
        run: zip -r MyApp-${{ env.TAG_NAME }}.zip dist/*.app

      - name: Install GitHub CLI
        run: |
          brew install gh

      - name: Create Release and Upload Asset
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # GitHub token for authentication
        run: |
          gh release create ${{ env.TAG_NAME }} MyApp-${{ env.TAG_NAME }}.zip --title "Release ${{ env.TAG_NAME }}" --notes "Automatically generated release"
